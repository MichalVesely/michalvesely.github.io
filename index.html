<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report nemovitosti – vizualizace JSON</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --brand:#2563eb; --brand-600:#1d4ed8;
      --bg:#f6f8fb; --card:#ffffff; --ink:#0f172a;
      --muted:#eef2f7; --muted-2:#e2e8f0;
      --shadow:0 12px 40px rgba(2,8,23,.06), 0 2px 6px rgba(2,8,23,.04);
      --r-lg:1rem; --r-md:.75rem;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); background:var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      display:grid; grid-template-rows:auto 1fr; gap:1.2rem;
    }
    .topbar{
      background:var(--card); box-shadow:var(--shadow);
      padding:1.2rem clamp(1rem,3vw,2rem); display:grid; gap:.75rem;
    }
    .title{display:flex; align-items:baseline; gap:.75rem; flex-wrap:wrap}
    h1{margin:0; font-size:clamp(1.25rem,2.6vw,1.8rem); line-height:1.2}
    .subtitle{color:#475569; font-size:.95rem}
    form{display:grid; grid-template-columns:1fr auto; gap:.6rem; width:min(980px,100%)}
    label{display:none}
    input[type="text"]{
      padding:.9rem 1rem; border:1px solid var(--muted-2); border-radius:var(--r-md); background:#fff; font-size:1rem; outline:none;
    }
    input[type="text"]:focus{border-color:var(--brand); box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    button{
      padding:.9rem 1rem; border:0; border-radius:var(--r-md); font-weight:600; font-size:1rem;
      color:#fff; background:var(--brand); cursor:pointer; display:inline-flex; align-items:center; gap:.5rem;
      transition:background .15s ease;
    }
    button:hover{background:var(--brand-600)}
    button[disabled]{opacity:.7; cursor:not-allowed}
    .btn-spinner{width:1em;height:1em;border:.2em solid rgba(255,255,255,.55); border-top-color:#fff; border-radius:50%; display:none; animation:spin .9s linear infinite}
    button[aria-busy="true"] .btn-spinner{display:inline-block}

    .content{padding:0 clamp(1rem,3vw,2rem) 2rem}
    .card{background:var(--card); border-radius:var(--r-lg); box-shadow:var(--shadow); padding:1rem}

    .empty{display:grid; place-items:center; padding:2rem; text-align:center; gap:.6rem; color:#334155}
    .empty svg{width:56px; height:56px; opacity:.7}
    .hint{font-size:.95rem; color:#475569}

    .grid{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:1rem}
    .thumb{display:grid; grid-template-rows:auto 1fr; gap:.6rem}
    .thumb h3{margin:0; font-size:1rem; font-weight:800; color:var(--brand)}
    .frame{
      background:var(--muted); border:1px solid var(--muted-2); border-radius:.9rem; overflow:hidden;
      min-height:240px; position:relative; display:grid; place-items:center;
    }
    .frame img{width:100%; height:100%; object-fit:cover; display:block; max-height:480px}
    .fallback{padding:1rem; opacity:.75}

    .result,.error{margin-top:1rem; padding:1rem; border-radius:.75rem; font-size:.97rem}
    .result{background:var(--muted)}
    .error{background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca}

    .section-title{margin:1rem 0 .4rem; font-weight:800; color:var(--brand)}
    .kv{display:grid; gap:.5rem}
    .table{width:100%; border-collapse:collapse; background:var(--muted); border-radius:.5rem; overflow:hidden}
    .table th,.table td{padding:.5rem .7rem; border-bottom:1px solid var(--muted-2); text-align:left; font-size:.95rem; vertical-align:top}
    .table th{background:#e0e7ef; width:42%}
    .table tr:last-child td{border-bottom:0}

    /* skeleton */
    .skeleton::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.55), transparent);
      transform:translateX(-100%); animation:shimmer 1.2s infinite;
    }
    .skeleton{background:var(--muted)}

    @media (max-width:1000px){ form{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes shimmer{to{transform:translateX(100%)}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">
      <h1>Report nemovitosti</h1>
      <div class="subtitle">Zobrazím <strong>všechny</strong> údaje ze schématu</div>
    </div>
    <form id="checker-form" autocomplete="off">
      <label for="address-input">Zadej adresu</label>
      <input id="address-input" type="text" maxlength="160" required placeholder="např. Okružní 7, Řež" />
      <button id="submit-btn" type="submit" aria-busy="false">
        <span class="btn-spinner" aria-hidden="true"></span>
        Získat report
      </button>
    </form>
  </div>

  <div class="content">
    <!-- stav -->
    <div id="output" class="card">
      <div class="empty" id="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M3 11a9 9 0 1118 0 9 9 0 01-18 0zm9-4v5l3 3"/>
        </svg>
        <div><strong>Zadej adresu</strong> a vyrobím report včetně satelitu, Street View, katastru a všech metadat.</div>
        <div class="hint">Webhook musí vrátit klíče <code>satellite_url</code>, <code>streetview_url</code>, <code>cadastre_url</code> a sekce dle schématu.</div>
      </div>
    </div>

    <!-- obrázky -->
    <div class="grid" id="images-grid" style="display:none;">
      <div class="card thumb">
        <h3>Satelit</h3>
        <div class="frame skeleton" id="frame-sat"><div class="fallback">Načítám…</div></div>
      </div>
      <div class="card thumb">
        <h3>Street View</h3>
        <div class="frame skeleton" id="frame-street"><div class="fallback">Načítám…</div></div>
      </div>
      <div class="card thumb">
        <h3>Katastr</h3>
        <div class="frame skeleton" id="frame-kat"><div class="fallback">Načítám…</div></div>
      </div>
    </div>

    <!-- souhrn + sekce -->
    <div id="details" class="kv" style="margin-top:1rem;"></div>

    <!-- nerzpoznaná data -->
    <div id="extras" class="kv" style="margin-top:1rem;"></div>
  </div>

  <script>
    const form   = document.getElementById('checker-form');
    const input  = document.getElementById('address-input');
    const btn    = document.getElementById('submit-btn');
    const output = document.getElementById('output');
    const grid   = document.getElementById('images-grid');
    const details= document.getElementById('details');
    const extras = document.getElementById('extras');

    const frameSat    = document.getElementById('frame-sat');
    const frameStreet = document.getElementById('frame-street');
    const frameKat    = document.getElementById('frame-kat');

    form.addEventListener('submit', onSubmit);

    async function onSubmit(e){
      e.preventDefault();
      const adress = (input.value || '').trim();
      if(!adress) return;

      // UI reset + loadery
      grid.style.display = 'none';
      output.innerHTML = '';
      details.innerHTML = '';
      extras.innerHTML = '';
      setButtonBusy(true);

      setFrameSkeleton(frameSat, true);
      setFrameSkeleton(frameStreet, true);
      setFrameSkeleton(frameKat, true);

      try {
        const res = await fetch('https://hook.eu2.make.com/t7uwl8n3si3xdvp17bi8dcs4toj4cpeh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adress })
        });
        if(!res.ok) throw new Error('Chyba komunikace s webhookem');
        const data = await res.json();

        // === Obrázky (přímo z klíčů dle schématu) ===
        mountImage(frameSat,    data.satellite_url, 'Satelitní snímek',   'Obrázek nedostupný');
        mountImage(frameStreet, data.streetview_url,'Street View snímek', 'Obrázek nedostupný');
        mountImage(frameKat,    data.cadastre_url,  'Katastrální snímek', 'Obrázek nedostupný');
        grid.style.display = 'grid';

        // === Detaily – zobrazíme všechny sekce a všechny jejich položky ===
        renderAllDetails(data);

        // === Nerzpoznané klíče (pokud existují) ===
        renderExtras(data);

        showInfo('Hotovo. Níže jsou všechny informace z odpovědi.');

      } catch (err) {
        showError('Došlo k chybě: ' + (err?.message || 'Neznámá chyba'));
        setFrameSkeleton(frameSat, false, 'Chyba načítání');
        setFrameSkeleton(frameStreet, false, 'Chyba načítání');
        setFrameSkeleton(frameKat, false, 'Chyba načítání');
      } finally {
        setButtonBusy(false);
      }
    }

    // === Render všech sekcí podle schématu ===
    function renderAllDetails(data){
      // Souhrn
      if (data.souhrn != null) {
        details.appendChild(sectionTitle('Souhrn'));
        const p = document.createElement('div');
        p.textContent = String(data.souhrn ?? '');
        details.appendChild(p);
      }

      // Identifikace objektu
      if (data.identifikace_objektu) {
        const obj = data.identifikace_objektu;
        details.appendChild(sectionTitle('Identifikace objektu'));
        const t = table();
        t.add('Adresa', renderPolozkaText(obj.adresa));
        t.add('Parcelní číslo', renderPolozkaText(obj.parcelni_cislo));
        t.add('GPS', renderGPS(obj.gps));
        t.add('Typ stavby', renderPolozkaText(obj.typ_stavby));
        t.add('Období výstavby', renderPolozkaText(obj.rok_vystavby_obdobi));
        t.add('Počet nadzemních podlaží', renderNumber(obj.pocet_podlazi?.nadzemni));
        t.add('Počet podzemních podlaží', renderNumber(obj.pocet_podlazi?.podzemni));
        t.add('Zdroje (počet podlaží)', renderZdroje(obj.pocet_podlazi?.zdroje));
        // Schéma vyžaduje stav_budovy (položka_text) – zobrazíme pokud přijde:
        if (obj.stav_budovy) {
          t.add('Stav budovy', renderPolozkaText(obj.stav_budovy));
        }
        details.appendChild(t.el);
      }

      // Konstrukce a technologie
      if (data.konstrukce_technologie) {
        const kon = data.konstrukce_technologie;
        details.appendChild(sectionTitle('Konstrukce a technologie'));
        const t = table();
        t.add('Kotelna', renderPolozkaStav(kon.kotelna));
        t.add('Trafostanice', renderPolozkaStav(kon.trafostanice));
        if (kon.material_nosnych_konstrukci) {
          const m = kon.material_nosnych_konstrukci;
          t.add('Svislé nosné konstrukce', renderPolozkaText(m.svisle));
          t.add('Vodorovné konstrukce', renderPolozkaText(m.vodorovne));
          t.add('Střecha', renderPolozkaText(m.strecha));
        }
        t.add('Požární úseky', renderPolozkaStav(kon.pozarni_useky));
        t.add('FVE (solární panely)', renderPolozkaStav(kon.fve));
        t.add('Nabíjecí stanice EV', renderPolozkaStav(kon.nabijeci_stanice_ev));
        t.add('Hydranty v okolí', renderPolozkaStav(kon.hydranty_v_okoli));
        t.add('Oplocení', renderPolozkaStav(kon.oploceni));
        t.add('Kamerový systém', renderPolozkaStav(kon.kamerovy_system));
        details.appendChild(t.el);
      }

      // Statistické a katastrální údaje
      if (data.statisticke_katastralni_udaje) {
        const s = data.statisticke_katastralni_udaje;
        details.appendChild(sectionTitle('Statistické a katastrální údaje'));
        const t = table();
        t.add('Zastavěná plocha (m²)', renderPolozkaCislo(s.zastavena_plocha_m2));
        t.add('Počet bytů', renderPolozkaCislo(s.pocet_bytu));
        t.add('Počet nadzemních podlaží', renderPolozkaCislo(s.pocet_nadzemnich_podlazi));
        t.add('Výtah', renderPolozkaText(s.vytah));
        t.add('Materiál nosných zdí', renderPolozkaText(s.material_nosnych_zdi));
        t.add('Způsob vytápění', renderPolozkaText(s.zpusob_vytapeni));
        if (s.napojeni_na_site) {
          const seznam = Array.isArray(s.napojeni_na_site.hodnota) ? s.napojeni_na_site.hodnota : [];
          t.add('Napojení na sítě', escapeHTML(seznam.join(', ')));
          t.add('Zdroje (napojení na sítě)', renderZdroje(s.napojeni_na_site.zdroje));
        }
        t.add('Počet obyvatel', renderPolozkaText(s.pocet_obyvatel));
        t.add('Vlastnictví', renderPolozkaText(s.vlastnictvi));
        details.appendChild(t.el);
      }

      // Lokalita a okolní prostředí
      if (data.lokalita_okolni_prostredi) {
        const l = data.lokalita_okolni_prostredi;
        details.appendChild(sectionTitle('Lokalita a okolní prostředí'));
        const t = table();
        t.add('Charakter', escapeHTML(l.charakter ?? ''));
        t.add('Hustota zástavby', escapeHTML(l.hustota_zastavby ?? ''));
        t.add('Vzdálenost k nejbližším objektům (m)', renderNumber(l.vzdalenost_k_nejblizsim_objektum_m));
        if (Array.isArray(l.obcanska_vybavenost)) {
          t.add('Občanská vybavenost', `<ul style="margin:0;padding-left:1.2em">${l.obcanska_vybavenost.map(x=>`<li>${escapeHTML(x)}</li>`).join('')}</ul>`);
        }
        t.add('Dopravní dostupnost', escapeHTML(l.dopravni_dostupnost ?? ''));
        t.add('Rizika', escapeHTML(l.rizika ?? ''));
        t.add('Okolní zeleň', escapeHTML(l.okolni_zelen ?? ''));
        t.add('Parkování', escapeHTML(l.parkovani ?? ''));
        details.appendChild(t.el);
      }
    }

    // === Pomocné renderer funkce (podle $defs) ===
    function renderPolozkaText(p){
      if (!p) return '';
      const val = p.hodnota ?? '';
      return `${escapeHTML(String(val))} ${renderZdroje(p.zdroje)}`;
    }
    function renderPolozkaCislo(p){
      if (!p) return '';
      const val = (p.hodnota ?? '') === '' || p.hodnota == null ? '' : String(p.hodnota);
      return `${escapeHTML(val)} ${renderZdroje(p.zdroje)}`;
    }
    function renderPolozkaStav(p){
      if (!p) return '';
      const s = p.stav ?? 'nezjištěno';
      const d = p.detail ?? '';
      const zd = renderZdroje(p.zdroje);
      const label = ['ano','ne','nezjištěno',null].includes(s) ? s : String(s);
      const text = d ? `${escapeHTML(label)} — ${escapeHTML(d)}` : escapeHTML(label);
      return `${text} ${zd}`;
    }
    function renderGPS(gps){
      if (!gps) return '';
      const lat = gps.hodnota?.lat;
      const lon = gps.hodnota?.lon;
      const coords = `Lat: ${escapeHTML(lat ?? '')}, Lon: ${escapeHTML(lon ?? '')}`;
      return `${coords} ${renderZdroje(gps.zdroje)}`;
    }
    function renderNumber(n){
      if (n == null) return '';
      return escapeHTML(String(n));
    }
    function renderZdroje(zs){
      if (!Array.isArray(zs) || zs.length===0) return '';
      const txt = zs.map(z => `${z.nazev}${Number.isFinite(z.duveryhodnost) ? ' ('+z.duveryhodnost+')' : ''}`).join(', ');
      return `<span style="font-size:90%;color:#64748b;"> [zdroje: ${escapeHTML(txt)}]</span>`;
    }

    // === Nerzpoznané klíče (aby se nic neztratilo) ===
    function renderExtras(data){
      const known = new Set([
        'satellite_url','streetview_url','cadastre_url',
        'souhrn','identifikace_objektu','konstrukce_technologie',
        'statisticke_katastralni_udaje','lokalita_okolni_prostredi'
      ]);
      const otherKeys = Object.keys(data || {}).filter(k => !known.has(k));
      if (!otherKeys.length) return;

      extras.appendChild(sectionTitle('Další (nerozpoznané) položky z JSONu'));
      const pre = document.createElement('pre');
      pre.className = 'card';
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.wordBreak = 'break-word';
      const obj = {};
      for (const k of otherKeys) obj[k] = data[k];
      pre.textContent = JSON.stringify(obj, null, 2);
      extras.appendChild(pre);
    }

    // === UI helpery ===
    function setButtonBusy(busy){
      btn.setAttribute('aria-busy', busy ? 'true' : 'false');
      btn.disabled = !!busy;
    }
    function setFrameSkeleton(frame, show, fallbackText){
      frame.classList.toggle('skeleton', !!show);
      if(show){ frame.innerHTML = '<div class="fallback">Načítám…</div>'; }
      else if (fallbackText){ frame.replaceChildren(makeFallback(fallbackText)); }
      else { frame.innerHTML = ''; }
    }
    function makeFallback(text){
      const div = document.createElement('div');
      div.className = 'fallback';
      div.textContent = text;
      return div;
    }
    function mountImage(frame, url, alt, fallbackText){
      setFrameSkeleton(frame, true);
      if(!url){
        setFrameSkeleton(frame, false, fallbackText);
        return;
      }
      const img = new Image();
      img.alt = alt || '';
      img.loading = 'lazy';
      img.referrerPolicy = 'no-referrer';
      img.onerror = () => setFrameSkeleton(frame, false, fallbackText);
      img.onload  = () => { frame.classList.remove('skeleton'); frame.replaceChildren(img); };
      img.src = url;
    }
    function sectionTitle(text){
      const el = document.createElement('div');
      el.className = 'section-title';
      el.textContent = text;
      return el;
    }
    function table(){
      const el = document.createElement('table');
      el.className = 'table';
      const tbody = document.createElement('tbody');
      el.appendChild(tbody);
      return {
        el,
        add(label, html){
          const tr = document.createElement('tr');
          const th = document.createElement('th'); th.textContent = label;
          const td = document.createElement('td'); td.innerHTML = html || '';
          tr.appendChild(th); tr.appendChild(td); tbody.appendChild(tr);
        }
      };
    }
    function showInfo(text){
      const el = document.createElement('div');
      el.className = 'result';
      el.textContent = text;
      output.replaceChildren(el);
    }
    function showError(text){
      const el = document.createElement('div');
      el.className = 'error';
      el.textContent = text;
      output.replaceChildren(el);
    }
    function escapeHTML(s){
      return String(s ?? '').replace(/[&<>"']/g, ch => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch]
      ));
    }
  </script>
</body>
</html>
